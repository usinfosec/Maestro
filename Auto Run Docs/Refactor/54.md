# Refactor Task 54: src/renderer/types/index.ts

## Summary

This 554-line file serves as the central type definitions for the renderer process. It's generally well-organized with good use of re-exports from shared locations. However, there are significant issues with type duplication across 3-4 locations, several dead/unused types, and 2 instances of `any` types that weaken type safety.

## Dead Code

1. **`LeaderboardRankingInfo`** (lines 534-539): Only referenced within this file, never imported elsewhere
2. **`LeaderboardSubmitResponse`** (lines 542-552): Only referenced within this file, never imported elsewhere
3. **`BadgeUnlockRecord`** (lines 241-244): Only referenced within this file (used by `AutoRunStats`), never imported elsewhere
4. **`WorkLogItem`** (lines 84-90): Defined but only used by `Session.workLog` field - and `workLog` itself appears unused in the codebase (only referenced in CLAUDE.md)
5. **`Shortcut`** (lines 29-33): Interface is defined but never imported anywhere in the codebase
6. **`FileArtifact`** (lines 35-40): Interface is defined but never imported - `Session.changedFiles` uses `FileArtifact[]` but the type seems only defined locally
7. **`QueuedItemType`** (line 65): Type alias defined but never imported - only used locally within `QueuedItem`

## Deprecated Patterns

1. **`Session.aiLogs`** (line 328): Comment at line 362 says "DEPRECATED: Use aiTabs[activeIndex].agentSessionId instead" but `aiLogs` is still initialized and defined without deprecation comment
2. **`Session.agentSessionId`** (line 363): Explicitly marked deprecated but still in use
3. **Legacy `BatchRunState` fields** (lines 163-168): Comment says "kept for backwards compatibility during migration" - these fields (`totalTasks`, `completedTasks`, `currentTaskIndex`, `scratchpadPath`, `originalContent`) should be evaluated for removal

## Duplication

1. **`ToolType`** - Defined in 3 locations:
   - `src/renderer/types/index.ts` (line 21)
   - `src/shared/types.ts` (line 4)
   - Multiple parsers define local copies

2. **`UsageStats`** - Defined in 5 locations:
   - `src/renderer/types/index.ts` (lines 213-226)
   - `src/shared/types.ts` (lines 26-39)
   - `src/renderer/global.d.ts` (lines 67-75)
   - `src/web/hooks/useWebSocket.ts` (local version with all optional fields)
   - `src/main/parsers/usage-aggregator.ts`

3. **`AgentConfig`** - Defined in 7 locations:
   - `src/renderer/types/index.ts` (lines 466-478)
   - `src/shared/types.ts` (lines 112-122)
   - `src/main/agent-detector.ts`
   - `src/main/preload.ts`
   - `src/renderer/global.d.ts` (lines 42-52)
   - Integration test file
   - AGENT_SUPPORT.md

4. **`ProcessConfig`** - Defined in 5 locations:
   - `src/renderer/types/index.ts` (lines 481-489)
   - `src/main/process-manager.ts`
   - `src/main/preload.ts`
   - `src/renderer/global.d.ts` (lines 12-31) - **Note: global.d.ts version has additional fields!**
   - `src/renderer/services/process.ts`

5. **`ShellInfo`** - Defined in 4 locations:
   - `src/renderer/types/index.ts` (lines 499-504)
   - `src/main/preload.ts`
   - `src/renderer/global.d.ts` (lines 60-65)
   - `src/main/utils/shellDetector.ts`

6. **`DirectoryEntry`** - Defined in 3 locations:
   - `src/renderer/types/index.ts` (lines 492-496)
   - `src/main/preload.ts`
   - `src/renderer/global.d.ts` (lines 54-58)

7. **`AgentConfigOption`** - Defined in 4 locations:
   - `src/renderer/types/index.ts` (lines 456-464)
   - `src/main/agent-detector.ts`
   - `src/renderer/global.d.ts` (lines 33-40)
   - Test file

8. **`Playbook` and `PlaybookDocumentEntry`** - Defined in 3 locations:
   - `src/renderer/types/index.ts` (lines 185-210)
   - `src/shared/types.ts` (lines 61-82)
   - ARCHITECTURE.md

9. **`WorktreeConfig`** and `BatchRunConfig`** - Defined in 2 locations:
   - `src/renderer/types/index.ts` (lines 114-130)
   - `src/shared/types.ts` (lines 93-109)

10. **`Group`** - Defined in 2 locations:
    - `src/renderer/types/index.ts` (lines 449-454)
    - `src/shared/types.ts` (lines 7-12)

11. **`CustomAICommand`** - Defined in 5 locations:
    - `src/renderer/types/index.ts` (lines 507-513)
    - `src/main/web-server.ts`
    - `src/main/web-server/routes/wsRoute.ts`
    - `src/main/web-server/services/broadcastService.ts`
    - ARCHITECTURE.md

## Code Smells

1. **God Type File**: At 554 lines, this file contains too many unrelated types. Consider splitting into:
   - `session-types.ts` (Session, AITab, ClosedTab, LogEntry, QueuedItem)
   - `batch-types.ts` (BatchRunState, BatchRunConfig, BatchDocumentEntry, Playbook)
   - `stats-types.ts` (UsageStats, GlobalStats, AutoRunStats, OnboardingStats)
   - `leaderboard-types.ts` (LeaderboardRegistration, LeaderboardRankingInfo, LeaderboardSubmitResponse)
   - `agent-types.ts` (AgentConfig, AgentConfigOption, ProcessConfig)

2. **Missing re-exports**: File has good re-exports from shared (lines 4-19) but then redefines many of the same types locally instead of importing

3. **Inconsistent field variance**:
   - `ProcessConfig` in global.d.ts has 9 additional fields vs this file's 7 fields
   - `AgentConfig.binaryName` is optional here but required in shared/types.ts

4. **Weak Session type**: `Session.fileTree: any[]` (line 352) uses `any` instead of proper typing

## Type Safety Issues

1. **`any` in `AgentConfigOption`** (lines 461, 463):
   - `default: any` - should use discriminated union based on `type` field
   - `argBuilder?: (value: any) => string[]` - should match the `type` field

2. **`any[]` for `fileTree`** (line 352): Should use proper file tree node type

3. **Missing `ProcessConfig` fields**: The renderer types/index.ts version is missing:
   - `images?: string[]`
   - `agentSessionId?: string`
   - `readOnlyMode?: boolean`
   - `modelId?: string`
   - `yoloMode?: boolean`
   - `sessionCustomPath?: string`
   - `sessionCustomArgs?: string`
   - `sessionCustomEnvVars?: Record<string, string>`
   - `sessionCustomModel?: string`

   These are present in global.d.ts, causing potential type mismatches.

4. **Duplicate type definitions with variations**: When the same interface is defined in multiple places with different fields, TypeScript won't catch mismatches. For example, `AgentConfig` has different required/optional fields across locations.

## Recommended Refactoring

1. **[High] Consolidate to shared/types.ts**: Move canonical definitions to `src/shared/types.ts` and import everywhere:
   - `UsageStats`, `ToolType`, `AgentConfig`, `ProcessConfig`, `ShellInfo`, `DirectoryEntry`
   - `CustomAICommand`, `Group`, `Playbook`, `BatchRunConfig`, `WorktreeConfig`

2. **[High] Remove duplicate definitions from global.d.ts**: Use re-exports from shared or renderer/types instead of redefining

3. **[Medium] Fix `any` types in `AgentConfigOption`**: Create proper generic or discriminated union:
   ```typescript
   interface AgentConfigOption<T = string | number | boolean> {
     default: T;
     argBuilder?: (value: T) => string[];
   }
   ```

4. **[Medium] Type `fileTree` properly**: Define `FileTreeNode` interface and use `FileTreeNode[]`

5. **[Medium] Remove dead types**: Delete `LeaderboardRankingInfo`, `LeaderboardSubmitResponse`, `BadgeUnlockRecord`, `Shortcut`, `FileArtifact`, `QueuedItemType` if truly unused, or add proper imports where needed

6. **[Low] Deprecate legacy `BatchRunState` fields**: Add `@deprecated` JSDoc comments to the 5 legacy fields

7. **[Low] Split into focused type files**: Break the 554-line file into 4-5 smaller focused modules for better organization

## Estimated Impact

**Risk Level: Medium** - Changes are structural reorganization and should not affect runtime behavior. However, extensive duplication means many files will need import updates.

**Testing Considerations:**
- TypeScript compilation should catch any import issues
- No runtime behavior changes expected
- Grep for duplicated interface names to find all usage sites
- Run full test suite after consolidation

**Migration Strategy:**
1. Canonicalize types in `shared/types.ts`
2. Update renderer/types/index.ts to re-export from shared
3. Update global.d.ts to use shared types
4. Update all import sites to use canonical locations
5. Remove duplicate definitions
